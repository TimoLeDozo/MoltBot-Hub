services:
  openclaw_proxy:
    image: ubuntu/squid:latest
    container_name: openclaw_proxy
    restart: unless-stopped
    volumes:
      - ./squid.conf:/etc/squid/squid.conf:ro
      - squid_logs:/var/log/squid

  moltbot:
    build: .
    container_name: moltbot_hub
    volumes:
      - ./config/clawdbot.json:/root/.openclaw/openclaw.json
      - ./config/cron:/root/.openclaw/cron
      - ./config/sandboxes/main/AGENTS.md:/root/.openclaw/workspace/AGENTS.md
      - ./config/sandboxes/main/BOOTSTRAP.md:/root/.openclaw/workspace/BOOTSTRAP.md
      - ./config/sandboxes/main/SOUL.md:/root/.openclaw/workspace/SOUL.md
      - ./config/sandboxes/main/TOOLS.md:/root/.openclaw/workspace/TOOLS.md
      - C:/Users/timca/AppData/Local/Temp:/host/windows/temp
      - ./workspace:/app/workspace
      - ./workspace/skills:/app/skills
    environment:
      # Configuration Ollama pour Clawdbot
      - OLLAMA_HOST=http://host.docker.internal:11434
      - OLLAMA_API_KEY=ollama-local
      - TELEGRAM_BOT_TOKEN=${TELEGRAM_TOKEN}
      - GOOGLE_AI_STUDIO_KEY=${GOOGLE_API_KEY}
      - NVIDIA_API_KEY=${NVIDIA_API_KEY}
      - BRAVE_API_KEY=${BRAVE_API_KEY}
      - HTTP_PROXY=http://openclaw_proxy:3128
      - HTTPS_PROXY=http://openclaw_proxy:3128
      - GLOBAL_AGENT_HTTP_PROXY=http://openclaw_proxy:3128
      - GLOBAL_AGENT_NO_PROXY=localhost,127.0.0.1,host.docker.internal,ollama,openclaw_proxy
      - NO_PROXY=localhost,127.0.0.1,host.docker.internal,ollama
      - NODE_TLS_REJECT_UNAUTHORIZED=1
      - HOST_WINDOWS_TEMP=/host/windows/temp
      # Configuration Chromium sans sandbox
      - PLAYWRIGHT_CHROMIUM_ARGS=--no-sandbox --disable-setuid-sandbox --disable-dev-shm-usage
      - PLAYWRIGHT_BROWSERS_PATH=/root/.cache/ms-playwright
    ports:
      - "18789:18789"
    # C'est ICI que la magie opère (ne supprime pas ça !)
    extra_hosts:
      - "host.docker.internal:host-gateway"
    restart: unless-stopped

    # Mémoire partagée pour Chromium (sans exposer l'IPC hôte)
    shm_size: '512m'

    # Restrictions de sécurité - Isolation du système hôte
    security_opt:
      - no-new-privileges:true
    cap_drop:
      - ALL
    cap_add:
      - NET_BIND_SERVICE
      - CHOWN
      - SETGID
      - SETUID
      - DAC_OVERRIDE

    # Limites de ressources pour prévenir DoS
    deploy:
      resources:
        limits:
          cpus: '2.0'
          memory: 4G
        reservations:
          cpus: '0.5'
          memory: 1G

    # Logging structuré pour audit et monitoring
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
        labels: "service=openclaw,env=production"
    depends_on:
      - openclaw_proxy
    networks:
      default:
        aliases:
          - moltbot_hub

volumes:
  squid_logs:
