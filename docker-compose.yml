services:
  moltbot:
    build: .
    container_name: moltbot_hub
    volumes:
      - ./config:/root/.clawdbot
      - ./config/clawdbot.json:/root/.openclaw/openclaw.json
      - ./config/cron:/root/.openclaw/cron
      - ./workspace:/app/workspace
      - ./workspace/skills:/app/skills
    environment:
      # Configuration Ollama pour Clawdbot
      - OLLAMA_HOST=http://host.docker.internal:11434
      - OLLAMA_API_KEY=ollama-local
      - TELEGRAM_BOT_TOKEN=${TELEGRAM_TOKEN}
      - GOOGLE_AI_STUDIO_KEY=${GOOGLE_API_KEY}
      - BRAVE_API_KEY=BSAtXC53giNg_egvlOCWC2QLCGz6e3Q
      # Configuration Chromium sans sandbox
      - PLAYWRIGHT_CHROMIUM_ARGS=--no-sandbox --disable-setuid-sandbox
      - PLAYWRIGHT_BROWSERS_PATH=/root/.cache/ms-playwright
    ports:
      - "18789:18789"
    # C'est ICI que la magie opère (ne supprime pas ça !)
    extra_hosts:
      - "host.docker.internal:host-gateway"
    restart: unless-stopped

    # Configuration IPC pour Chromium (mémoire partagée)
    ipc: host

    # Restrictions de sécurité - Isolation du système hôte
    security_opt:
      - no-new-privileges:true
    cap_drop:
      - ALL
    cap_add:
      - NET_BIND_SERVICE
      - CHOWN
      - SETGID
      - SETUID
      - DAC_OVERRIDE

    # Limites de ressources pour prévenir DoS
    deploy:
      resources:
        limits:
          cpus: '2.0'
          memory: 4G
        reservations:
          cpus: '0.5'
          memory: 1G

    # Logging structuré pour audit et monitoring
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
        labels: "service=openclaw,env=production"